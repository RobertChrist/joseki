<!DOCTYPE html>
<html>
<head>
<script src="./wgo/wgo/wgo.min.js"></script>
<style>
* { box-sizing: border-box;}
.container {display:flex; flex-direction:row; height:100%; width: 100%;}
.control { padding: 10px; }
</style>
</head>
<body>


<div class="container"><div id="board"></div>

    <div class="control">
        <button onClick="pass()">Pass</button>
        <button onClick="restart()">Reset</button>
        <div id="log"></div>
        <div id="msg"></div>
    </div>
</div>
</body>

<script>
var josekis = [
    ['15,3', '16,5', '13,2', '17,3', '16,2', '16,8'],
    ['15,3', '16,5', '16,4', '15,5', '13,2', '15,9'],
    ['15,3', '16,3', '18,0', '15,4', '18,1', '14,3', '18,2', '15,2', '18,3'],
    ['pass', '15,3', '16,5', '13,2', '17,3', '16,2', '16,8'],
];
var tree;
var board;
var game;

function pass() {
}

function restart() {


    tree = {};
    for (const joseki of josekis){
        var cur_tree = tree;
        for (const move of joseki) {
            if (! (move in cur_tree)) {
                cur_tree[move] = {};
            }
            cur_tree = cur_tree[move];
        }
    }

    var cont = document.querySelector(".container");
    cont.removeChild(cont.childNodes[0]);
    var boardElement = document.createElement("div");
    boardElement.id = "board";
    cont.insertBefore(boardElement, cont.firstChild);

    board = new WGo.Board(document.getElementById("board"), {
    width: 600,
    section: {
        top: 0,
        right: 0,
        left: 8,
        bottom:8 
    }
    });
    game = new WGo.Game();


    board.addEventListener("click", handleMove);
    document.getElementById('log').innerHTML = '';
    document.getElementById('msg').innerHTML = '';
}

function parseMove(move) {
    var coords = move.split(",");
    return [parseInt(coords[0]), parseInt(coords[1])];
}

function play(x, y) {
    let turn = game.turn;
    let result = game.play(x,y);
    if (Array.isArray(result)) {
        board.addObject({ x: x, y: y, c: turn });
        document.getElementById('log').innerHTML += turn + ": " + x + ","+y+"<br>";;
        if (result.length) {
            for (const cap of result) {
                board.removeObjectsAt(cap.x, cap.y);
            }
        }
    }
}

function handleMove(x, y) {
        let move = x+","+y;
        play(x,y);

        if (move in tree) {
            tree = tree[move];

            const possibleMoves = Object.keys(tree);
            if(possibleMoves.length > 0) {
                const chosenMove = possibleMoves[Math.floor(Math.random() * possibleMoves.length)];
                let [x,y] = parseMove(chosenMove);
                play(x,y);
                tree = tree[chosenMove];
            }


            if(Object.keys(tree).length == 0){
                document.getElementById('msg').innerHTML = "DONE!";
                board.removeEventListener('click', handleMove);
            }
        }else{
            board.removeEventListener('click', handleMove);
            document.getElementById('msg').innerHTML = "FAIL";
            let [x,y] = parseMove(move);
            board.removeObjectsAt(x, y);
            board.addObject({ x: x, y: y, type: 'MA' });
            for (const correct of Object.keys(tree)) {
                let [x,y] = parseMove(correct);
                board.addObject({x: x, y:y, type: 'CR'});
            }
            
        }
}


restart();
</script>
</html>
